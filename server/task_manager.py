# =============================================================================
# server/task_manager.py
# =============================================================================
# ğŸ¯ ç›®çš„ï¼š
# æ­¤æª”æ¡ˆå®šç¾©äº†åœ¨ Agent-to-Agent (A2A) å”è­°ä¸‹å¦‚ä½•ç®¡ç†ä»»å‹™ã€‚
#
# âœ… åŒ…å«ï¼š
# - ä¸€å€‹åŸºç¤æŠ½è±¡é¡åˆ¥ `TaskManager`ï¼Œè¦ç¯„å¿…é ˆå¯¦ä½œçš„æ–¹æ³•
# - ä¸€å€‹ç°¡å–®çš„ `InMemoryTaskManager`ï¼Œå°‡ä»»å‹™æš«å­˜åœ¨è¨˜æ†¶é«”ä¸­
#
# âŒ ä¸åŒ…å«ï¼š
# - å–æ¶ˆä»»å‹™åŠŸèƒ½
# - æ¨æ’­é€šçŸ¥æˆ–å³æ™‚æ›´æ–°
# - æ°¸ä¹…æ€§å„²å­˜ï¼ˆå¦‚è³‡æ–™åº«ï¼‰
# =============================================================================


# -----------------------------------------------------------------------------
# ğŸ“š æ¨™æº– Python åŒ¯å…¥
# -----------------------------------------------------------------------------

from abc import ABC, abstractmethod        # è®“æˆ‘å€‘å¯ä»¥å®šç¾©æŠ½è±¡åŸºåº•é¡åˆ¥ï¼ˆåƒä»‹é¢ï¼‰
from typing import Dict                    # Dict æ˜¯ç”¨ä¾†å­˜æ”¾éµå€¼å°çš„å­—å…¸å‹åˆ¥
import asyncio                             # é€™è£¡ç”¨æ–¼é–å®šï¼Œå®‰å…¨è™•ç†éåŒæ­¥æ“ä½œ


# -----------------------------------------------------------------------------
# ğŸ“¦ å°ˆæ¡ˆåŒ¯å…¥ï¼šè«‹æ±‚èˆ‡ä»»å‹™æ¨¡å‹
# -----------------------------------------------------------------------------

from models.request import (
    SendTaskRequest, SendTaskResponse,    # ç”¨æ–¼ç™¼é€ä»»å‹™çµ¦ä»£ç†
    GetTaskRequest, GetTaskResponse       # ç”¨æ–¼æŸ¥è©¢ä»£ç†çš„ä»»å‹™è³‡è¨Š
)

from models.task import (
    Task, TaskSendParams, TaskQueryParams,  # ä»»å‹™èˆ‡è¼¸å…¥æ¨¡å‹
    TaskStatus, TaskState, Message          # ä»»å‹™ç‹€æ…‹èˆ‡æ­·å²è¨Šæ¯ç‰©ä»¶
)


# -----------------------------------------------------------------------------
# ğŸ§© TaskManagerï¼ˆæŠ½è±¡åŸºåº•é¡åˆ¥ï¼‰
# -----------------------------------------------------------------------------

class TaskManager(ABC):
    """
    ğŸ”§ é€™æ˜¯ä¸€å€‹åŸºç¤ä»‹é¢é¡åˆ¥ã€‚

    æ‰€æœ‰ Task Manager éƒ½å¿…é ˆå¯¦ä½œé€™å…©å€‹ async æ–¹æ³•ï¼š
    - on_send_task()ï¼šæ¥æ”¶ä¸¦è™•ç†æ–°ä»»å‹™
    - on_get_task()ï¼šæŸ¥è©¢ä»»å‹™ç‹€æ…‹æˆ–å°è©±æ­·å²

    é€™ç¢ºä¿æ‰€æœ‰å¯¦ä½œéƒ½éµå¾ªä¸€è‡´çš„çµæ§‹ã€‚
    """

    @abstractmethod
    async def on_send_task(self, request: SendTaskRequest) -> SendTaskResponse:
        """ğŸ“¥ æ­¤æ–¹æ³•å°‡è™•ç†æ–°é€²ä¾†çš„ä»»å‹™ã€‚"""
        pass

    @abstractmethod
    async def on_get_task(self, request: GetTaskRequest) -> GetTaskResponse:
        """ğŸ“¤ æ­¤æ–¹æ³•å°‡æ ¹æ“šä»»å‹™ ID å›å‚³ä»»å‹™ç´°ç¯€ã€‚"""
        pass


# -----------------------------------------------------------------------------
# ğŸ§  InMemoryTaskManager
# -----------------------------------------------------------------------------

class InMemoryTaskManager(TaskManager):
    """
    ğŸ§  ä¸€å€‹ç°¡å–®ã€æš«æ™‚çš„ä»»å‹™ç®¡ç†å™¨ï¼Œæ‰€æœ‰è³‡æ–™éƒ½å­˜åœ¨è¨˜æ†¶é«”ï¼ˆRAMï¼‰ä¸­ã€‚

    é©åˆï¼š
    - å±•ç¤ºã€Demo
    - æœ¬åœ°é–‹ç™¼
    - å–®ä¸€æœƒè©±äº’å‹•

    â— ä¸é©åˆæ­£å¼ç’°å¢ƒï¼šæ‡‰ç”¨ç¨‹å¼åœæ­¢æˆ–é‡å•Ÿæ™‚è³‡æ–™æœƒéºå¤±ã€‚
    """

    def __init__(self):
        self.tasks: Dict[str, Task] = {}   # ğŸ—ƒï¸ å­—å…¸ï¼Œkey=ä»»å‹™IDï¼Œvalue=Taskç‰©ä»¶
        self.lock = asyncio.Lock()         # ğŸ” éåŒæ­¥é–ï¼Œç¢ºä¿åŒæ™‚åªæœ‰ä¸€å€‹è«‹æ±‚èƒ½ä¿®æ”¹è³‡æ–™

    # -------------------------------------------------------------------------
    # ğŸ’¾ upsert_task: åœ¨è¨˜æ†¶é«”ä¸­å»ºç«‹æˆ–æ›´æ–°ä»»å‹™
    # -------------------------------------------------------------------------
    async def upsert_task(self, params: TaskSendParams) -> Task:
        """
        è‹¥ä»»å‹™ä¸å­˜åœ¨å‰‡å»ºç«‹æ–°ä»»å‹™ï¼Œè‹¥å·²å­˜åœ¨å‰‡æ›´æ–°æ­·å²ç´€éŒ„ã€‚

        åƒæ•¸ï¼š
            params: TaskSendParams â€“ åŒ…å«ä»»å‹™IDã€æœƒè©±IDèˆ‡è¨Šæ¯

        å›å‚³ï¼š
            Task â€“ æ–°å»ºç«‹æˆ–å·²æ›´æ–°çš„ä»»å‹™
        """
        async with self.lock:
            task = self.tasks.get(params.id)  # å˜—è©¦æ‰¾å‡ºæ˜¯å¦å·²æœ‰æ­¤IDçš„ä»»å‹™

            if task is None:
                # è‹¥ä»»å‹™ä¸å­˜åœ¨ï¼Œå»ºç«‹ä¸€å€‹ç‹€æ…‹ç‚º "submitted" çš„æ–°ä»»å‹™
                task = Task(
                    id=params.id,
                    status=TaskStatus(state=TaskState.SUBMITTED),
                    history=[params.message]
                )
                self.tasks[params.id] = task
            else:
                # è‹¥ä»»å‹™å·²å­˜åœ¨ï¼Œå°‡æ–°è¨Šæ¯åŠ å…¥æ­·å²ç´€éŒ„
                task.history.append(params.message)

            return task

    # -------------------------------------------------------------------------
    # ğŸš« on_send_task: å¿…é ˆç”±å­é¡åˆ¥å¯¦ä½œ
    # -------------------------------------------------------------------------
    async def on_send_task(self, request: SendTaskRequest) -> SendTaskResponse:
        """
        æ­¤æ–¹æ³•åœ¨é€™è£¡æ•…æ„ä¸å¯¦ä½œã€‚
        åƒ `AgentTaskManager` é€™æ¨£çš„å­é¡åˆ¥æ‡‰è©²è¦è¦†å¯«å®ƒã€‚

        ä¾‹å¤–ï¼š
            NotImplementedErrorï¼šå¦‚æœç›´æ¥å‘¼å«æœƒæ‹‹å‡ºæ­¤éŒ¯èª¤
        """
        raise NotImplementedError("on_send_task() å¿…é ˆç”±å­é¡åˆ¥å¯¦ä½œ")

    # -------------------------------------------------------------------------
    # ğŸ“¥ on_get_task: ä¾ä»»å‹™IDæŸ¥è©¢ä»»å‹™
    # -------------------------------------------------------------------------
    async def on_get_task(self, request: GetTaskRequest) -> GetTaskResponse:
        """
        ä¾æ“šä»»å‹™IDæŸ¥è©¢ä»»å‹™ï¼Œä¸¦å¯é¸æ“‡åªå›å‚³æœ€è¿‘çš„è¨Šæ¯ã€‚

        åƒæ•¸ï¼š
            request: ä¸€å€‹å¸¶æœ‰IDèˆ‡å¯é¸æ­·å²é•·åº¦çš„ GetTaskRequest

        å›å‚³ï¼š
            GetTaskResponse â€“ è‹¥æ‰¾åˆ°å‰‡åŒ…å«ä»»å‹™ï¼Œå¦å‰‡å›å‚³éŒ¯èª¤è¨Šæ¯
        """
        async with self.lock:
            query: TaskQueryParams = request.params
            task = self.tasks.get(query.id)

            if not task:
                # è‹¥æ‰¾ä¸åˆ°ä»»å‹™ï¼Œå›å‚³çµæ§‹åŒ–éŒ¯èª¤
                return GetTaskResponse(id=request.id, error={"message": "æ‰¾ä¸åˆ°ä»»å‹™"})

            # å¯é¸ï¼šåªé¡¯ç¤ºæœ€è¿‘ N ç­†è¨Šæ¯
            task_copy = task.model_copy()  # è¤‡è£½ä¸€ä»½ï¼Œé¿å…å½±éŸ¿åŸå§‹è³‡æ–™
            if query.historyLength is not None:
                task_copy.history = task_copy.history[-query.historyLength:]  # å–æœ€å¾Œ N ç­†è¨Šæ¯
            else:
                task_copy.history = task_copy.history

            return GetTaskResponse(id=request.id, result=task_copy)
